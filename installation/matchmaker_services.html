<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Matchmaker Services - Bevygap DRAFT</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../favicon.svg">
                        <link rel="shortcut icon" href="../favicon.png">
                <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
                <link rel="stylesheet" href="../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../installation/index.html"><strong aria-hidden="true">2.</strong> Installation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../installation/nats.html"><strong aria-hidden="true">2.1.</strong> NATS Server Setup</a></li><li class="chapter-item expanded "><a href="../installation/bevygap_nats.html"><strong aria-hidden="true">2.2.</strong> Bevygap NATS Setup</a></li><li class="chapter-item expanded "><a href="../installation/edgegap.html"><strong aria-hidden="true">2.3.</strong> Edgegap Setup</a></li><li class="chapter-item expanded "><a href="../installation/matchmaker_services.html" class="active"><strong aria-hidden="true">2.4.</strong> Matchmaker Services</a></li><li class="chapter-item expanded "><a href="../installation/game_client.html"><strong aria-hidden="true">2.5.</strong> Game Client</a></li></ol></li><li class="chapter-item expanded "><a href="../containerizing/index.html"><strong aria-hidden="true">3.</strong> Containerizing Services</a></li><li class="chapter-item expanded "><a href="../development/index.html"><strong aria-hidden="true">4.</strong> Developing your Game</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Bevygap DRAFT</h1>

                    <div class="right-buttons">
                                                <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="matchmaker-services"><a class="header" href="#matchmaker-services">Matchmaker Services</a></h1>
<p>To review, so far we have a public NATS server, and Edgegap is ready to deploy instances of our gameserver.</p>
<p>The next step is to configure the matchmaker services.</p>
<p>The game will talk to the matchmaker webservice to say &quot;i want to play&quot;. The matchmaker will then make requests to the Edgegap API to find or start a server to play on, create a Lightyear Connect Token, and reply to the game client with something that looks like this:</p>
<p><strong>Example successful response from matchmaker:</strong></p>
<pre><code class="language-json">{
    token: &quot;TkVUQ09ERSAxLjAyANU4AQAAAAAAxV...snip...&quot;,
    ip: &quot;172.104.236.32&quot;,
    port: 30004,
    cert_digest: &quot;e3:76:4d:86:6c:11:d1:96...snip...&quot;
} 
</code></pre>
<p>The <code>ip</code> and <code>port</code> are the public IP and external port of the gameserver deployment on Edgegap.
The <code>token</code> is a Lightyear Connect Token that the client has to pass to the gameserver when connecting. Behind the scenes this is linked to an Edgegap session ID.
The <code>cert_digest</code> allows browsers to verify the WebTransport server's self-signed certificate. This is automatically generated by gameservers when they start up.</p>
<p>Once the game client has this response, it triggers Lightyear to make the connection to the gameserver.</p>
<h2 id="to-docker-or-not-to-docker"><a class="header" href="#to-docker-or-not-to-docker">To docker or not to docker?</a></h2>
<p>I'll show how to start the services without docker, because it's easier to test and develop them this way. Know that there are github actions that will build and containerize all this, so you can run them alongside the NATS server with docker-compose. (explanation of this to follow in a later section.)</p>
<h2 id="running-the-matchmaker-service"><a class="header" href="#running-the-matchmaker-service">Running the Matchmaker Service</a></h2>
<p>Make sure your shell has the NATS and Edgegap environment variables set:</p>
<pre><code class="language-bash">set -a &amp;&amp; . ./nats.env &amp;&amp; set +a
set -a &amp;&amp; . ./edgegap.env &amp;&amp; set +a
</code></pre>
<p>Run the matchmaker. This is the service that talks to Edgegap, and also generates Lightyear Connect Tokens.
It needs to know the lightyear server private key and protocol id to make the tokens.</p>
<p>At the moment, the lightyear private key and protocol id are compiled into the gameserver.
Search the <code>bevygap-spaceships</code> code for <code>PRIVATE_KEY</code> and <code>PROTOCOL_ID</code> to find them, hopefully these are still the correct values:</p>
<pre><code class="language-bash">cargo run -p bevygap_matchmaker -- \
  --app-name bevygap-spaceships \
  --app-version 1 \
  --lightyear-protocol-id 80085 \
  --lightyear-private-key '1, 2, 3, 4, 5, 6, 7, 8, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1'
</code></pre>
<h2 id="running-the-matchmaker-webservice"><a class="header" href="#running-the-matchmaker-webservice">Running the Matchmaker Webservice</a></h2>
<p>The matchmaker is listening to a NATS topic, ready to create sessions. The webservice exposes this via HTTP (websockets) to game clients.</p>
<p>In another shell, set your NATS environment variables:</p>
<pre><code class="language-bash">set -a &amp;&amp; . ./nats.env &amp;&amp; set +a
</code></pre>
<p>And run:</p>
<pre><code class="language-bash">cargo run -p bevygap_matchmaker_httpd -- --cors http://127.0.0.1
</code></pre>
<p>One of the log lines should show you that the matchmaker webservice listens on port 3000:</p>
<pre><code>INFO bevygap_matchmaker_httpd: bevygap_matchmaker_httpd listening on 0.0.0.0:3000  
</code></pre>
<h2 id="testing-the-matchmaker-webservice"><a class="header" href="#testing-the-matchmaker-webservice">Testing the Matchmaker Webservice</a></h2>
<p>Let's test the matchmaker webservice without a game client. Open up your browser to <a href="http://localhost:3000" target="_new">http://localhost:3000</a> so the page has the correct security context.
Find the developer tools console, and paste in this javascript to simulate a real client asking for a match over a websocket connection:</p>
<pre><code class="language-javascript">const ws = new WebSocket(&quot;ws://localhost:3000/matchmaker/ws&quot;);

ws.onopen = () =&gt; {
    console.log(&quot;Connected to WebSocket&quot;);

    const payload = {
        client_ip: &quot;81.128.157.123&quot;,
        game: &quot;bevygap-spaceships&quot;,
        version: &quot;1&quot;
    };
    
    ws.send(JSON.stringify(payload));
    console.log(&quot;Sent payload:&quot;, payload);
};

ws.onmessage = (event) =&gt; {
    console.log(&quot;Received message:&quot;, event.data);
};

ws.onclose = () =&gt; {
    console.log(&quot;WebSocket connection closed&quot;);
};
</code></pre>
<p><img src="../assets/ws-test-js.png" alt="Websocket test in browser" /></p>
<p>If that worked, you will notice a new deployment is running in the Edgegap dashboard, and a new Edgegap session is active.</p>
<p>After a minute or so, the matchmaker will realise that no game client ever consumed that connect token, and delete the Edgegap session.</p>
<p>After 10 minutes of no sessions linked to the deployment, Edgegap will stop the deployment.</p>
<p>Feel free to manually terminate it now.</p>
<h2 id="shall-we-play-a-game"><a class="header" href="#shall-we-play-a-game">Shall we play a game?</a></h2>
<p>The matchmaking webservices are ready – time to connect with a game client!</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../installation/edgegap.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../installation/game_client.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../installation/edgegap.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../installation/game_client.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
