<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Edgegap Setup - Bevygap DRAFT</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../favicon.svg">
                        <link rel="shortcut icon" href="../favicon.png">
                <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
                <link rel="stylesheet" href="../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../installation/index.html"><strong aria-hidden="true">2.</strong> Installation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../installation/nats.html"><strong aria-hidden="true">2.1.</strong> NATS Server Setup</a></li><li class="chapter-item expanded "><a href="../installation/bevygap_nats.html"><strong aria-hidden="true">2.2.</strong> Bevygap NATS Setup</a></li><li class="chapter-item expanded "><a href="../installation/edgegap.html" class="active"><strong aria-hidden="true">2.3.</strong> Edgegap Setup</a></li><li class="chapter-item expanded "><a href="../installation/matchmaker_services.html"><strong aria-hidden="true">2.4.</strong> Matchmaker Services</a></li><li class="chapter-item expanded "><a href="../installation/game_client.html"><strong aria-hidden="true">2.5.</strong> Game Client</a></li></ol></li><li class="chapter-item expanded "><a href="../containerizing/index.html"><strong aria-hidden="true">3.</strong> Containerizing Services</a></li><li class="chapter-item expanded "><a href="../development/index.html"><strong aria-hidden="true">4.</strong> Developing your Game</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Bevygap DRAFT</h1>

                    <div class="right-buttons">
                                                <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="edgegap-setup"><a class="header" href="#edgegap-setup">Edgegap Setup</a></h1>
<p>Sign up for a free account at <a href="https://edgegap.com">Edgegap</a>.</p>
<p>Free accounts are limited to a single &quot;deployment&quot; (in Edgegap vernacular, a deployment is a single instance of your gameserver running on their infrastructure), which is fine for testing and development.</p>
<p>From the Edgegap dashboard, find your API key.</p>
<p>Put it in <code>edgegap.env</code>, like this:</p>
<p><strong>edgegap.env:</strong></p>
<pre><code>EDGEGAP_API_KEY=&quot;token asjhgaskjdhasd-kjhasd-asd-asd-asd&quot;
</code></pre>
<h3 id="deploying-a-gameserver-to-edgegap"><a class="header" href="#deploying-a-gameserver-to-edgegap">Deploying a gameserver to Edgegap</a></h3>
<p>Fork the <a href="https://github.com/RJ/bevygap-spaceships/">bevygap-spaceships</a> repository into your own github account. 
This is the Lightyear &quot;spaceships&quot; example game, modified to run as a headless server and client that expects to connect using Webtransport (and is thus WASM-compatible).</p>
<p>To build the gameserver docker image with Github Actions, you must tell github some of your credentials.</p>
<p>Visit the &quot;Container Registry&quot; page on the Edgegap dashboard, to see the credentials you need to push
docker images to Edgegap's container registry.</p>
<p>On Github, go to the <code>Settings / Secrets and variables / Actions</code> page of your newly forked bevygap-spaceships repo, and add these secrets:</p>
<p>| Secret Name             | Example value                                   |
| ----------------------- | ----------------------------------------------- |
| EDGEGAP_IMAGE_NAME      | metabrew-kfk5fha5fsct/bevygap-spaceships-server |
| EDGEGAP_DOCKER_REGISTRY | registry.edgegap.com                            |
| EDGEGAP_DOCKER_USERNAME | robot$metabrew-kfk5fha5fsct+client-push         |
| EDGEGAP_DOCKER_PASSWORD | ....password from edgegap dashboard...          |</p>
<h3 id="building-the-gameserver"><a class="header" href="#building-the-gameserver">Building the gameserver</a></h3>
<p>To trigger the github action that builds the gameserver docker image and publishes it to Edgegap's container registry, either commit a new git tag, or visit the &quot;Actions&quot; page of the repo, select the &quot;Build server&quot; action, and click &quot;Run workflow&quot;. Enter a version like <code>v1.0.0</code>.</p>
<p>At the time of writing, this was taking between 10 and 15 minutes to complete. This time can probably be reduced with some docker/github/caching trickery.</p>
<p>Once it completes, check the Edgegap container registry page to see that the image was published.</p>
<h3 id="make-an-edgegap-application"><a class="header" href="#make-an-edgegap-application">Make an Edgegap Application</a></h3>
<p>Now we configure an Edgegap Application.</p>
<p>In the Edgegap dashboard, under &quot;Applications&quot;, create a new application called <code>bevygap-spaceships</code>. Set it to use the Edgegap container registry, select the image you published (eg: <code>youruser-abc123/bevygap-spaceships-server</code>), and choose the tag you used when building the server, eg <code>1.0.0</code>.</p>
<p>Other settings:</p>
<table><thead><tr><th>Setting</th><th>Value</th></tr></thead><tbody>
<tr><td>Session Type</td><td>Seat</td></tr>
<tr><td>Session Sockets</td><td>6</td></tr>
<tr><td>Empty Time to Live</td><td>10 minutes</td></tr>
<tr><td>Auto Deploy</td><td>Enabled</td></tr>
</tbody></table>
<h3 id="add-a-port-mapping"><a class="header" href="#add-a-port-mapping">Add a Port Mapping</a></h3>
<p>You must tell Edgegap what port(s) your gameserver listens on. These will be mapped to a different external port for clients to use when connecting.</p>
<p>Add a port with these settings:</p>
<table><thead><tr><th>Setting</th><th>Value</th></tr></thead><tbody>
<tr><td>Protocol</td><td>UDP</td></tr>
<tr><td>Port</td><td>6420</td></tr>
<tr><td>Name</td><td>server</td></tr>
<tr><td>Verifications</td><td>true</td></tr>
<tr><td>TLS Upgrade</td><td>false</td></tr>
</tbody></table>
<p>Port 6420 is the port that <code>bevygap-spaceships</code> listens on. (ie: <code>0.0.0.0:6420</code>)</p>
<h3 id="add-environment-variables"><a class="header" href="#add-environment-variables">Add Environment Variables</a></h3>
<p>Set the env vars that bevygap needs to connect to NATS, and the lightyear key:</p>
<table><thead><tr><th>Name</th><th>Value</th><th>Notes</th></tr></thead><tbody>
<tr><td>NATS_USER</td><td>gameserver</td><td>from your nats-server.conf</td></tr>
<tr><td>NATS_PASSWORD</td><td>gameserver</td><td>from your nats-server.conf</td></tr>
<tr><td>NATS_HOST</td><td>1.2.3.4</td><td>Your NATS server public IP</td></tr>
<tr><td>LIGHYEAR_PRIVATE_KEY</td><td>[1, 2, 3, 4, 5, 6, ... 1]</td><td>From the game source</td></tr>
</tbody></table>
<h4 id="providing-the-rootcapem-file-to-the-gameserver-container"><a class="header" href="#providing-the-rootcapem-file-to-the-gameserver-container">Providing the rootCA.pem file to the gameserver container</a></h4>
<p>If you're using a self-signed certificate for your NATS server, you need to provide the CA root certificate to the gameserver, otherwise it won't be able to verify the NATS server's certificate.</p>
<p>Setting <code>NATS_CA</code> to the path to the rootCA.pem file works, but we didn't include the .pem file in the docker image.</p>
<p>Setting <code>NATS_CA_CONTENTS</code> to the contents of the rootCA.pem file would work, except Edgegap limits ENVs to 255 bytes (I've asked them to increase this limit!).</p>
<h5 id="slight-hack"><a class="header" href="#slight-hack">Slight Hack..</a></h5>
<p>To work around this, <code>bevygap_server_plugin</code> looks for a <code>--ca_contents 'XXXXX'</code> flag on startup, and if found, will write the contents to a temporary file and pass that as <code>NATS_CA</code> for you. The Edgegap dashboard doesn't support setting docker arguments for server startup, but does support it via the API.</p>
<p>Use the <code>set-caroot-argument.sh</code> script to set the flag via the API:</p>
<pre><code class="language-bash">$ ./utils/set-caroot-argument.sh 
Usage: ./utils/set-caroot-argument.sh &lt;appname&gt; &lt;appversion&gt; &lt;path to rootCA.pem file&gt;

$ ./utils/set-caroot-argument.sh &quot;bevygap-spaceships&quot; &quot;1&quot; &quot;/Users/rj/Library/Application Support/mkcert/rootCA.pem&quot;
🔧 Sending PATCH command to https://api.edgegap.com/v1/app/bevygap-spaceships/version/1

{&quot;success&quot;:true,&quot;version&quot;:{&quot;arguments&quot;:&quot;--ca_contents '-----BEGIN CERTIFICATE-----MIIE2zCCA0Og..snip...'...}}

✅ OK. Deployments of bevygap-spaceships at version 1 will have --ca_contents '&lt;...contents...&gt;' passed as arguments.
</code></pre>
<p>You need to do this for each version. During devlopment, I've been reusing the version and simply bumping the container tag associated with that application version. Don't be tempted to rely on a 'latest' docker tag though, Edgegap's caching doesn't like that. Make sure to specify a new version each time.</p>
<p>When adapting this process for your own gameserver, you could ship your rootCA.pem in the server's docker container,
in which case just set <code>NATS_CA=/path/to/rootCA.pem</code> as an Environment Variable in the Edgegap dashboard.</p>
<p>Alternatively, set up LetsEncrypt, get a trusted cert for your NATS server domain, and you won't need to provide the root CA file at all.</p>
<small>
It's also possible to set up Edgegap "pull profiles" to yoink files from a configured S3 bucket on boot, but that is out of scope here..
</small>
<h3 id="deploying-a-gameserver"><a class="header" href="#deploying-a-gameserver">Deploying a gameserver</a></h3>
<p>Once we have the server image published and the application version configured correctly, deployments should work.</p>
<p>Typically the matchmaker triggers a deployment for you, but to test, we can deploy manually, and verify the server starts up OK.</p>
<blockquote>
<p><strong>Why not watch NATS traffic for this bit?</strong>
<br>Subscribe to the everything wildcard in nats from your local machine.
<br> A server starting up will publish something:
<br>TODO: lookup the actual NATS topic i'm using instead of '&gt;'</p>
<pre><code class="language-bash">nats sub '&gt;'
</code></pre>
</blockquote>
<p>Go to &quot;Deployments&quot; in the Edgegap dashboard, &quot;Create Deployment&quot;, select our application and version, and click &quot;Deploy&quot;.</p>
<p>The list of IP addresses are placeholders, and edgegap will use the geolocation of those IPs to figure out where in the world to run the server. Normally those are player IPs.</p>
<p>Once it starts, have a look at the &quot;Container Logs&quot; tab.  All being well, it will have connected to NATS and be waiting for clients to connect.</p>
<p>The &quot;Deployment Details&quot; also shows you the port mapping, so you can see the external port that maps to the internal 6420 port. You won't be able to connect a client to it just yet – the next step is the matchmaker service that issues valid Lightyear connect tokens.</p>
<p>Use the &quot;Terminate Deployment&quot; button to stop the server. The next time it starts up should be in response to a matchmaker request.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../installation/bevygap_nats.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../installation/matchmaker_services.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../installation/bevygap_nats.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../installation/matchmaker_services.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
