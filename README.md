# Bevygap – Multiplayer server management tools

This is a (WIP) suite of services for running multiplayer game servers on [Edgegap](https://edgegap.com), where the games are
built with Bevy using the [Lightyear](https://crates.io/crates/lightyear) networking library.

The goal is to have an easy-to-deploy system either yourself with docker-compose, or in the cloud,
to use Edgegap to spin up gameservers on demand. 

## Connection flow

* Game client talks to `bevygap_http` by GETting `/wannaplay`, expecting a `ConnectToken` and gameserver `ip:port`.
* This makes a nats request to `session.gensession`, which the matchmaker service handles.
* An edgegap session is created, which corresponds to a gameserver instance (which may be autodeployed in response to this session creation)
* Matchmaker generates a Lightyear `ConnectToken`, and associates the token's `ClientId` with the edgegap session ID in NATS KV.
* Client uses the `ConnectToken` to connect to the gameserver
* Gameserver maintains a list of active connections in NATS KV, which the matchmaker watches.
* When a client disconnects, the gameserver removes their entry from `active_connection`, causing the matchmaker to delete the Edgegap session.

## Components

### bevygap_matchmaker

Clients wishing to connect to the game make a request to our matchmaker service, which then:

* Creates an Edgegap session (which may trigger a new server deployment)
* Creates a new Lightyear client id and connect token, associated with the session
* Stores the token/session mapping in NATS KV
* Returns the connect token, and gameserver IP and port to the client.
  (the gameserver ip+port will be a machine controlled by Edgegap, running your game server's docker image)
* Deletes edgegap sessions when clients disconnect, by watching `active_connections` in NATS KV

### bevygap_httpd

An http endpoint to make "i want to play" requests to the matchmaker.
The matchmaker itself only exposes a service to NATS, not http.

### bevygap_webhook_sink

Listens for webhooks on http, and writes to NATS. Edgegap can send webhooks for session and deployment events.

### bevygap_client_plugin

A bevy plugin for the game client, to replace the normal lightyear `commands.connect_client()` call.
The new `commands.bevygap_connect_client()` function will make a request to the matchmaker, then modify lightyear's config to set the supplied
game server socket address and connect token, then call `commands.connect_client()` for you.

### bevygap_server_plugin

A bevy plugin for the gameserver, which loads its deployment context from the edgegap API on boot,
and connects to our NATS instance in order to lookup session information. Your gameserver should
be a docker image that runs on Edgegap's infrastructure.

When a player connects, we lookup the Edgegap session ID in NATS KV that corresponds to the `client_id` from the `ConnectToken`.

Maintains `active_connections` NATS KV entries for all connected players, which allows the matchmaker to clean up sessions when clients disconnect.

### bevygap_shared

Shared code for the NATS stuff, used between the matchmaker and gameserver.

### nats

[NATS](https://nats.io/) is the shared state and messaging backend between our various components.

### edgegap-client

Autogenerated client for the edgegap API using `openapi-generator`. See `gen-edgegap-client.sh`.

# Running

You need an edgegap account, with your gameserver's docker image built and pushed to a registry.
The gameserver must use the `bevygap_server_plugin`, with NATS configured correctly.

```bash
# This will start nats, the matchmaker, and the httpd
docker-compose up
```

```bash
# Example matchmaking request
nats req session.gensession '{"client_ip": "81.128.172.55", "foo":123}'
```
<pre>
14:24:33 Sending request on "session.gensession"
14:24:34 Received with rtt 481.2565ms
{"connect_token":"TkV...AAAA=","gameserver_ip":"172.104.159.122","gameserver_port":32041,"link":"172.104.159.122:32041"}
</pre>

```bash
# Note that NATS KV now links the assigned session id to the client id from the issued token.
nats kv ls

╭───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│                                                   Key-Value Buckets                                                   │
├────────────────┬──────────────────────────────────────────────────┬─────────────────────┬──────┬────────┬─────────────┤
│ Bucket         │ Description                                      │ Created             │ Size │ Values │ Last Update │
├────────────────┼──────────────────────────────────────────────────┼─────────────────────┼──────┼────────┼─────────────┤
│ sessions_eg2ly │ Maps Edgegap Session IDs to Lightyear Client IDs │ 2024-10-05 13:33:12 │ 69 B │ 1      │ 12.92s      │
│ sessions_ly2eg │ Maps Lightyear Client IDs to Edgegap Session IDs │ 2024-10-05 13:33:12 │ 69 B │ 1      │ 12.92s      │
╰────────────────┴──────────────────────────────────────────────────┴─────────────────────┴──────┴────────┴─────────────╯

# get the Session ID from the lightyear client id:
nats kv get sessions_ly2eg "123456.."
```

If running outside docker, source the (non-exported) envs:
```bash
set -a && . ./.matchmaker.env && set +a
```


## Nats setup

To run with TLS on a public IP, so that game servers can connect, you'll need to figure this out yourself or use a hosted nats service.

<small>
I happen to be using traefik to maintain my letsencrypt certs, so i export those certs to use for nats, on a domain I already serve https on.
</small>

Check your deployment (a game server) connected to nats, by looking at:
```
nats server report connections
```

## Error handling

Is "unfinished".. 

I'm polling on session creation before replying to the mm request, and it never took more than 3 seconds so far, even when deploying a new server, so i've not bothered handling timeouts properly yet.

## NOTES / TODO

probably want to prefix all NATS subjects/buckets with the edgegap app name or something, so that
multiple apps on edgegap can share the nats instance without conflicts.

should probably be restricted by the nats creds


need to split LY's spaceships into own repo with separate crates, containerise the server,
add the bevygap stuff, demonstrate the whole deal.

# WebTransport custom certificate requirements

https://w3c.github.io/webtransport/#dom-webtransportoptions-servercertificatehashes

https://w3c.github.io/webtransport/#verify-a-certificate-hash

Strict cert requirements, we autogenerate one on boot and report the digest to the client, so
as long as the server doesn't stay up for more than 14 days, we're fine.