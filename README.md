# Bevygap – Multiplayer server management tools

This is a (WIP) suite of services for running multiplayer game servers on [Edgegap](https://edgegap.com), where the games are
built with Bevy using the [Lightyear](https://crates.io/crates/lightyear) networking library.

The goal is to have an easy-to-deploy system either yourself with docker-compose, or in the cloud,
to use Edgegap to spin up gameservers on demand. 

## Connection flow

* Game client talks to `bevygap_http` by GETting `/wannaplay`, expecting a `ConnectToken` and gameserver `ip:port`.
* This makes a nats request to `session.gensession`, which the matchmaker service handles.
* An edgegap session is created, which corresponds to a gameserver instance (which may be autodeployed in response to this session creation)
* Matchmaker generates a Lightyear `ConnectToken`, and associates the token's `ClientId` with the edgegap session ID in NATS KV.
* Client uses the `ConnectToken` to connect to the gameserver
* Gameserver maintains a list of active connections in NATS KV, which the matchmaker watches.
* When a client disconnects, the gameserver removes their entry from `active_connection`, causing the matchmaker to delete the Edgegap session.

## Components

### bevygap_matchmaker

Clients wishing to connect to the game make a request to our matchmaker service, which then:

* Creates an Edgegap session (which may trigger a new server deployment)
* Creates a new Lightyear client id and connect token, associated with the session
* Stores the token/session mapping in NATS KV
* Returns the connect token, and gameserver IP and port to the client.
  (the gameserver ip+port will be a machine controlled by Edgegap, running your game server's docker image)
* Deletes edgegap sessions when clients disconnect, by watching `active_connections` in NATS KV

### bevygap_httpd

An http endpoint to make "i want to play" requests to the matchmaker.
The matchmaker itself only exposes a service to NATS, not http.

### bevygap_webhook_sink

Listens for webhooks on http, and writes to NATS. Edgegap can send webhooks for session and deployment events.

### bevygap_client_plugin

A bevy plugin for the game client, to replace the normal lightyear `commands.connect_client()` call.
The new `commands.bevygap_connect_client()` function will make a request to the matchmaker, then modify lightyear's config to set the supplied
game server socket address and connect token, then call `commands.connect_client()` for you.

### bevygap_server_plugin

A bevy plugin for the gameserver, which loads its deployment context from the edgegap API on boot,
and connects to our NATS instance in order to lookup session information. Your gameserver should
be a docker image that runs on Edgegap's infrastructure.

When a player connects, we lookup the Edgegap session ID in NATS KV that corresponds to the `client_id` from the `ConnectToken`.

Maintains `active_connections` NATS KV entries for all connected players, which allows the matchmaker to clean up sessions when clients disconnect.

### bevygap_shared

Shared code for the NATS stuff, used between the matchmaker and gameserver.

### nats

[NATS](https://nats.io/) is the shared state and messaging backend between our various components.

### edgegap-client

Autogenerated client for the edgegap API using `openapi-generator`. See `gen-edgegap-client.sh`.

# Running

You need an edgegap account, with your gameserver's docker image built and pushed to a registry.
The gameserver must use the bevygap_gameserver plugin, with NATS configured correctly.

```bash
# This will start nats, the matchmaker, and the httpd
docker-compose up
```

```bash
# Example matchmaking request
nats req session.gensession '{"client_ip": "81.128.172.55", "foo":123}'
```
<pre>
14:24:33 Sending request on "session.gensession"
14:24:34 Received with rtt 481.2565ms
{"connect_token":"TkV...AAAA=","gameserver_ip":"172.104.159.122","gameserver_port":32041,"link":"172.104.159.122:32041"}
</pre>

```bash
# Note that NATS KV now links the assigned session id to the client id from the issued token.
nats kv ls

╭───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│                                                   Key-Value Buckets                                                   │
├────────────────┬──────────────────────────────────────────────────┬─────────────────────┬──────┬────────┬─────────────┤
│ Bucket         │ Description                                      │ Created             │ Size │ Values │ Last Update │
├────────────────┼──────────────────────────────────────────────────┼─────────────────────┼──────┼────────┼─────────────┤
│ sessions_eg2ly │ Maps Edgegap Session IDs to Lightyear Client IDs │ 2024-10-05 13:33:12 │ 69 B │ 1      │ 12.92s      │
│ sessions_ly2eg │ Maps Lightyear Client IDs to Edgegap Session IDs │ 2024-10-05 13:33:12 │ 69 B │ 1      │ 12.92s      │
╰────────────────┴──────────────────────────────────────────────────┴─────────────────────┴──────┴────────┴─────────────╯

# get the Session ID from the lightyear client id:
nats kv get sessions_ly2eg "123456.."
```

If running outside docker, source the (non-exported) envs:
```bash
set -a && . ./.matchmaker.env && set +a
```


## Nats setup

```
# server cert
mkcert -cert-file server-cert.pem -key-file server-key.pem localhost ::1 127.0.0.1 nats
# using CA:
cat "$(mkcert -CAROOT)/rootCA.pem"

mkcert -client -cert-file client-cert.pem -key-file client-key.pem localhost ::1 127.0.0.1 email@localhost matchmaker

```

## NOTES

My nats setup for initial live testing is tls server with username+pass auth.

Check gameserver(s) connected to nats:
```
nats server report connections
```

## Timeouts

When there are no deployments, or nothing suitable, it takes too long to return a ready session,
so the game client http req times out. ideally need to stream status updates to game client?

<pre>
GET SESSION... (1)    
2024-10-09T14:03:25.069729Z  INFO bevygap_matchmaker::session_service: SessionGet { session_id: "a1cb46bc7f15-S", custom_id: None, status: "Seeking", ready: false, linked: false, kind: "Seat", user_count: 1, app_version: 55039, create_time: "2024-10-09 14:03:24.975285", elapsed: 0, error: None, session_users: Some([SessionUser { ip: "81.128.xx", latitude: Some(53.1651), longitude: Some(-1.482) }]), session_ips: None, deployment: None, webhook_url: None }    

2024-10-09T14:03:38.642584Z  INFO bevygap_matchmaker: NEW GAMESERVER: Message { subject: Subject { bytes: b"gameserver.contexts" }, reply: None, payload: b"{\"fqdn\":\"835d0d69f2fc.pr.edgegap.net\",\"location\":{\"administrative_division\":\"North Holland\",\"city\":\"Amsterdam\",\"continent\":\"Europe\",\"country\":\"Netherlands\",\"latitude\":51.9688,\"longitude\":4.7688,\"timezone\":\"Central European Time\"},\"ports\":{\"server port\":{\"external\":30898,\"internal\":5420,\"link\":\"835d0d69f2fc.pr.edgegap.net:30898\",\"name\":\"server port\",\"protocol\":\"UDP\",\"proxy\":null,\"tls_upgrade\":false}},\"public_ip\":\"172.235.165.125\",\"ready\":false,\"request_id\":\"835d0d69f2fc\",\"sockets\":10,\"sockets_usage\":0,\"status\":\"Status.DEPLOYING\",\"whitelisting_active\":false}", headers: None, status: None, description: None, length: 581 }    

2024-10-09T14:06:45.071178Z  INFO bevygap_matchmaker::session_service: GET SESSION... (2)    

2024-10-09T14:06:45.729178Z  INFO bevygap_matchmaker::session_service: SessionGet { session_id: "a1cb46bc7f15-S", custom_id: None, status: "Ready", ready: true, linked: true, kind: "Seat", user_count: 1, app_version: 55039, create_time: "2024-10-09 14:03:24.975285", elapsed: 201, error: None, session_users: Some([SessionUser { ip: "81.128.xx", latitude: Some(53.1651), longitude: Some(-1.482) }]), session_ips: None, deployment: Some(Deployment { request_id: "835d0d69f2fc", public_ip: "172.235.165.125", status: "Status.READY", ready: true, whitelisting_active: false, fqdn: "835d0d69f2fc.pr.edgegap.net", ports: Some({"server port": PortMapping { external: Some(30898), internal: Some(5420), protocol: Some("UDP"), name: Some("server port"), tls_upgrade: Some(false), link: Some("835d0d69f2fc.pr.edgegap.net:30898"), proxy: None }}), location: None, tags: None, sockets: None, sockets_usage: None, is_joinable_by_session: None }), webhook_url: None }    

2024-10-09T14:06:45.729231Z  INFO bevygap_matchmaker::session_service: SessionGet { session_id: "a1cb46bc7f15-S", custom_id: None, status: "Ready", ready: true, linked: true, kind: "Seat", user_count: 1, app_version: 55039, create_time: "2024-10-09 14:03:24.975285", elapsed: 201, error: None, session_users: Some([SessionUser { ip: "81.128.xx", latitude: Some(53.1651), longitude: Some(-1.482) }]), session_ips: None, deployment: Some(Deployment { request_id: "835d0d69f2fc", public_ip: "172.235.165.125", status: "Status.READY", ready: true, whitelisting_active: false, fqdn: "835d0d69f2fc.pr.edgegap.net", ports: Some({"server port": PortMapping { external: Some(30898), internal: Some(5420), protocol: Some("UDP"), name: Some("server port"), tls_upgrade: Some(false), link: Some("835d0d69f2fc.pr.edgegap.net:30898"), proxy: None }}), location: None, tags: None, sockets: None, sockets_usage: None, is_joinable_by_session: None }), webhook_url: None }    

2024-10-09T14:06:45.729881Z  INFO bevygap_matchmaker::session_service: client_id = 12894362149030772046    

2024-10-09T14:06:45.730154Z  INFO bevygap_matchmaker::session_service: 🏠 BUILD ConnectToken: server_addresses = 172.235.165.125:30898 proto id: 1982, client_id: 12894362149030772046, privkey: [xxx]    
2024-10-09T14:06:45.784967Z  INFO bevygap_matchmaker::session_service: Stored token for session a1cb46bc7f15-S in NATS KV    
</pre>